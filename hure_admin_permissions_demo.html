<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HURE Core — Admin Permissions Behavior Demo</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --primary:#16a34a;
      --primaryHover:#15803d;
      --danger:#dc2626;
      --chip:#eef2ff;
      --chipText:#3730a3;
      --shadow: 0 18px 40px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      background:#0b1220;
      color:#e2e8f0;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:5;
    }
    header .title{
      font-weight:800;
      letter-spacing:.2px;
    }
    header .badge{
      background:rgba(22,163,74,.15);
      color:#86efac;
      border:1px solid rgba(22,163,74,.25);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      margin-left:10px;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto;
      padding:0 18px 48px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
    }
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:16px 16px 8px;
      font-size:18px;
    }
    .sub{
      padding:0 16px 16px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .toolbar{
      display:flex;
      gap:10px;
      padding:0 16px 16px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      border:none;
      background:var(--primary);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{background:var(--primaryHover)}
    .btn.secondary{
      background:#e2e8f0;
      color:#0f172a;
    }
    .btn.secondary:hover{background:#cbd5e1}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:#475569;
      font-weight:800;
      padding:10px 16px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:#f8fafc;
    }
    tbody td{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid;
    }
    .pill.admin{background:#ecfeff; border-color:#67e8f9; color:#155e75;}
    .pill.employee{background:#f1f5f9; border-color:#e2e8f0; color:#334155;}
    .pill.active{background:#dcfce7; border-color:#86efac; color:#166534;}
    .pill.inactive{background:#fee2e2; border-color:#fca5a5; color:#991b1b;}
    .actions a{
      color:#0f766e;
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      margin-right:10px;
    }
    .actions a:hover{ text-decoration:underline; }
    .note{
      padding:14px 16px 18px;
      font-size:13px;
      color:#334155;
      line-height:1.45;
      border-top:1px solid var(--border);
      background:#fbfdff;
    }
    code.inline{
      background:#f1f5f9;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid var(--border);
      font-size:12px;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:20;
    }
    .modal{
      width:min(820px, 100%);
      background:var(--surface);
      border-radius:14px;
      box-shadow:var(--shadow);
      border:1px solid rgba(226,232,240,.9);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:#ffffff;
    }
    .modalHeader h3{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .x{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      color:#64748b;
      padding:4px 8px;
    }
    .modalBody{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .field label{
      font-size:12px;
      font-weight:900;
      color:#475569;
      display:block;
      margin-bottom:6px;
    }
    .field input, .field select{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      outline:none;
      font-size:14px;
    }
    .field input:focus, .field select:focus{
      border-color:#94a3b8;
      box-shadow:0 0 0 3px rgba(148,163,184,.25);
    }
    .fullRow{ grid-column:1 / -1; }

    /* Permissions card */
    .permCard{
      display:none;
      grid-column:1 / -1;
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:#f8fafc;
    }
    .permTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .permTop .left{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .permTitle{
      font-weight:950;
      font-size:14px;
    }
    .permHint{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid #c7d2fe;
      color:var(--chipText);
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ filter:brightness(.98); }
    .chip.muted{
      background:#f1f5f9;
      border-color:#e2e8f0;
      color:#334155;
      cursor:default;
    }
    .modules{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .module{
      background:white;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }
    .moduleHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .moduleName{
      font-weight:950;
      font-size:13px;
    }
    .bundleTag{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid var(--border);
      color:#475569;
      white-space:nowrap;
    }
    .permList label{
      display:flex;
      gap:8px;
      align-items:flex-start;
      font-size:13px;
      padding:6px 2px;
      cursor:pointer;
    }
    .permList input{ margin-top:2px; }
    .footer{
      padding:14px 16px;
      border-top:1px solid var(--border);
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .footer .left{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .btnRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:#0b1220;
      color:#e2e8f0;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 12px 26px rgba(2,6,23,.22);
      font-size:13px;
      display:none;
      z-index:30;
      max-width:min(900px, 92vw);
      white-space:pre-wrap;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
      .modalBody{grid-template-columns:1fr}
      .modules{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="title">HURE Core — Permissions Behavior Demo</div>
      <div class="badge">Enterprise • active</div>
    </div>
    <div class="small">Purpose: show expected UX when System Role = ADMIN</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>Staff Management (Demo)</h2>
        <div class="sub">
          Click <b>Edit</b> on a staff row and change <code class="inline">System Role</code>.
          When <b>ADMIN</b> is selected, a <b>Permissions Card</b> must automatically appear so the employer can manually choose permissions.
        </div>

        <div class="toolbar">
          <div class="small"><b>Rule:</b> ADMIN ≠ Full access • ADMIN = eligible for elevated permissions</div>
          <button class="btn" id="addStaffBtn">+ Add Staff (demo)</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Job Title</th>
              <th>System Role</th>
              <th>Status</th>
              <th style="width:140px;">Actions</th>
            </tr>
          </thead>
          <tbody id="staffTbody"></tbody>
        </table>

        <div class="note">
          <b>What this demo proves:</b><br/>
          1) Selecting <code class="inline">ADMIN</code> immediately reveals a permissions panel (grouped by module).<br/>
          2) Bundles are only guidance chips (optional presets) — they do not lock choices.<br/>
          3) Permissions are saved <i>per user</i>, allowing different ADMINs to have different access.
        </div>
      </div>

      <div class="card">
        <h2>Saved Output (Developer View)</h2>
        <div class="sub">This panel shows what would be sent to backend on save.</div>
        <div style="padding:0 16px 18px;">
          <pre id="output" style="margin:0; padding:12px; border-radius:12px; background:#0b1220; color:#e2e8f0; overflow:auto; border:1px solid rgba(226,232,240,.12); min-height:280px;"></pre>
          <div class="small" style="margin-top:10px;">
            Suggested backend shape: <code class="inline">userId</code>, <code class="inline">systemRole</code>, <code class="inline">permissionIds[]</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h3 id="modalTitle">Edit Staff Member</h3>
        <button class="x" id="closeBtn" aria-label="Close">×</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label>First Name</label>
          <input id="firstName" placeholder="e.g. Amina"/>
        </div>
        <div class="field">
          <label>Last Name</label>
          <input id="lastName" placeholder="e.g. Otieno"/>
        </div>

        <div class="field fullRow">
          <label>Email</label>
          <input id="email" placeholder="e.g. amina@clinic.com"/>
        </div>

        <div class="field">
          <label>Job Title</label>
          <input id="jobTitle" placeholder="e.g. HR Assistant"/>
        </div>

        <div class="field">
          <label>System Role</label>
          <select id="systemRole">
            <option value="EMPLOYEE">EMPLOYEE</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>

        <div class="field fullRow">
          <label>Location</label>
          <select id="location">
            <option value="main clinic">main clinic</option>
            <option value="mosomi branch">mosomi branch</option>
          </select>
        </div>

        <!-- Permissions Card (auto opens for ADMIN) -->
        <div class="permCard" id="permCard">
          <div class="permTop">
            <div class="left">
              <div class="permTitle">Admin Permissions</div>
              <div class="permHint">
                Selecting <b>ADMIN</b> should show this panel automatically. Employer manually chooses permissions.
                Bundles below are optional presets (guidance only).
              </div>
            </div>
            <div class="chips">
              <span class="chip muted">Bundle presets:</span>
              <span class="chip" data-bundle="HR">HR</span>
              <span class="chip" data-bundle="Payroll">Payroll</span>
              <span class="chip" data-bundle="Operations">Operations</span>
              <span class="chip" data-bundle="Clear">Clear</span>
            </div>
          </div>

          <div class="modules" id="modules"></div>
        </div>
      </div>

      <div class="footer">
        <div class="left">
          <b>Note:</b> EMPLOYEE users should not receive elevated permissions.
          Only ADMIN users are eligible to be assigned permissions.
        </div>
        <div class="btnRow">
          <button class="btn secondary" id="cancelBtn">Cancel</button>
          <button class="btn" id="saveBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // --- Demo data ---
  const PERMISSIONS = [
    // Staff / HR
    { id: "staff.view", label: "View staff", module: "Staff", bundle: "HR" },
    { id: "staff.edit", label: "Add / Edit staff", module: "Staff", bundle: "HR" },
    { id: "docs.upload", label: "Upload documents", module: "Documents", bundle: "HR" },
    { id: "docs.assign", label: "Assign policies/documents", module: "Documents", bundle: "HR" },

    // Payroll
    { id: "payroll.view", label: "View payroll", module: "Payroll", bundle: "Payroll" },
    { id: "payroll.run", label: "Finalize payroll", module: "Payroll", bundle: "Payroll" },
    { id: "payroll.export", label: "Export payroll (CSV)", module: "Payroll", bundle: "Payroll" },

    // Operations / Scheduling / Attendance
    { id: "schedule.create", label: "Create shifts", module: "Scheduling", bundle: "Operations" },
    { id: "schedule.assign", label: "Assign staff to shifts", module: "Scheduling", bundle: "Operations" },
    { id: "attendance.manage", label: "Manage attendance", module: "Attendance", bundle: "Operations" }
  ];

  let staff = [
    { id: "u1", firstName:"Manoj", lastName:"Ravadi", email:"manoj@demo.com", jobTitle:"Nurse", systemRole:"EMPLOYEE", location:"mosomi branch", status:"Active", permissionIds: [] },
    { id: "u2", firstName:"Barath", lastName:"Mani", email:"barath@demo.com", jobTitle:"HR Manager", systemRole:"ADMIN", location:"main clinic", status:"Active", permissionIds: ["staff.view","staff.edit","docs.upload","docs.assign"] },
    { id: "u3", firstName:"Kishore", lastName:"M", email:"kishore@demo.com", jobTitle:"Shift Manager", systemRole:"ADMIN", location:"mosomi branch", status:"Active", permissionIds: ["schedule.create","schedule.assign","attendance.manage"] }
  ];

  // --- DOM refs ---
  const tbody = document.getElementById("staffTbody");
  const overlay = document.getElementById("overlay");
  const closeBtn = document.getElementById("closeBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");
  const addStaffBtn = document.getElementById("addStaffBtn");
  const output = document.getElementById("output");
  const toast = document.getElementById("toast");

  const firstName = document.getElementById("firstName");
  const lastName = document.getElementById("lastName");
  const email = document.getElementById("email");
  const jobTitle = document.getElementById("jobTitle");
  const systemRole = document.getElementById("systemRole");
  const locationSel = document.getElementById("location");

  const permCard = document.getElementById("permCard");
  const modulesEl = document.getElementById("modules");

  let editingId = null;

  // --- helpers ---
  const groupBy = (arr, key) =>
    arr.reduce((acc, x) => ((acc[x[key]] ||= []).push(x), acc), {});

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 2300);
  }

  function renderTable(){
    tbody.innerHTML = "";
    staff.forEach(u=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(u.firstName)} ${escapeHtml(u.lastName)}</b><div class="small">${escapeHtml(u.email)}</div></td>
        <td>${escapeHtml(u.jobTitle || "-")}</td>
        <td>${u.systemRole === "ADMIN"
            ? `<span class="pill admin">ADMIN</span>`
            : `<span class="pill employee">EMPLOYEE</span>`}
        </td>
        <td>${u.status === "Active"
            ? `<span class="pill active">Active</span>`
            : `<span class="pill inactive">Inactive</span>`}
        </td>
        <td class="actions">
          <a data-action="edit" data-id="${u.id}">Edit</a>
          <a data-action="toggle" data-id="${u.id}">${u.status === "Active" ? "Deactivate" : "Activate"}</a>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function openModal(user){
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden","false");

    if(user){
      editingId = user.id;
      document.getElementById("modalTitle").textContent = "Edit Staff Member";
      firstName.value = user.firstName || "";
      lastName.value = user.lastName || "";
      email.value = user.email || "";
      jobTitle.value = user.jobTitle || "";
      systemRole.value = user.systemRole || "EMPLOYEE";
      locationSel.value = user.location || "main clinic";

      // render modules + check current permissions
      renderPermissions(user.permissionIds || []);
      setPermCardVisibility(systemRole.value);
    } else {
      editingId = null;
      document.getElementById("modalTitle").textContent = "Add Staff Member (Demo)";
      firstName.value = "";
      lastName.value = "";
      email.value = "";
      jobTitle.value = "";
      systemRole.value = "EMPLOYEE";
      locationSel.value = "main clinic";
      renderPermissions([]);
      setPermCardVisibility("EMPLOYEE");
    }
  }

  function closeModal(){
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");
  }

  function setPermCardVisibility(role){
    if(role === "ADMIN"){
      permCard.style.display = "block";   // <-- THIS is the behavior being requested in production
    } else {
      permCard.style.display = "none";
      // In real app you might also clear permissions when switching to EMPLOYEE (optional).
    }
  }

  function renderPermissions(selectedIds){
    modulesEl.innerHTML = "";
    const byModule = groupBy(PERMISSIONS, "module");

    Object.keys(byModule).forEach(moduleName=>{
      const perms = byModule[moduleName];
      const mod = document.createElement("div");
      mod.className = "module";
      const bundle = perms[0]?.bundle || "—";

      mod.innerHTML = `
        <div class="moduleHead">
          <div class="moduleName">${escapeHtml(moduleName)}</div>
          <div class="bundleTag">Bundle: ${escapeHtml(bundle)}</div>
        </div>
        <div class="permList">
          ${perms.map(p=>`
            <label>
              <input type="checkbox" data-perm-id="${p.id}" ${selectedIds.includes(p.id) ? "checked" : ""}/>
              <span>${escapeHtml(p.label)}</span>
            </label>
          `).join("")}
        </div>
      `;
      modulesEl.appendChild(mod);
    });
  }

  function getSelectedPermissionIds(){
    return Array.from(modulesEl.querySelectorAll('input[type="checkbox"][data-perm-id]'))
      .filter(cb => cb.checked)
      .map(cb => cb.getAttribute("data-perm-id"));
  }

  function applyBundle(bundleName){
    const ids = PERMISSIONS
      .filter(p => p.bundle === bundleName)
      .map(p => p.id);

    // check only those ids (but keep user ability to customize after)
    modulesEl.querySelectorAll('input[type="checkbox"][data-perm-id]').forEach(cb=>{
      cb.checked = ids.includes(cb.getAttribute("data-perm-id"));
    });
    showToast(`Applied bundle preset: ${bundleName} (guidance only)`);
  }

  function clearPermissions(){
    modulesEl.querySelectorAll('input[type="checkbox"][data-perm-id]').forEach(cb=> cb.checked = false);
    showToast("Cleared all permissions");
  }

  function writeOutput(payload){
    output.textContent = JSON.stringify(payload, null, 2);
  }

  // --- Events ---
  tbody.addEventListener("click", (e)=>{
    const a = e.target.closest("a[data-action]");
    if(!a) return;
    const id = a.getAttribute("data-id");
    const action = a.getAttribute("data-action");
    const user = staff.find(x=>x.id===id);

    if(action === "edit" && user){
      openModal(user);
    }
    if(action === "toggle" && user){
      user.status = user.status === "Active" ? "Inactive" : "Active";
      renderTable();
      showToast(`Status updated: ${user.firstName} is now ${user.status}`);
    }
  });

  addStaffBtn.addEventListener("click", ()=> openModal(null));
  closeBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

  systemRole.addEventListener("change", ()=>{
    setPermCardVisibility(systemRole.value);
    if(systemRole.value === "ADMIN"){
      showToast("ADMIN selected → Permissions panel is now visible");
    } else {
      showToast("EMPLOYEE selected → Permissions panel hidden");
    }
  });

  // bundle chips
  document.querySelectorAll(".chip[data-bundle]").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      const b = chip.getAttribute("data-bundle");
      if(systemRole.value !== "ADMIN"){
        showToast("Select ADMIN to assign permissions");
        return;
      }
      if(b === "Clear") return clearPermissions();
      applyBundle(b);
    });
  });

  saveBtn.addEventListener("click", ()=>{
    const role = systemRole.value;
    const permissionIds = (role === "ADMIN") ? getSelectedPermissionIds() : [];

    const payload = {
      id: editingId || "new_user_id",
      firstName: firstName.value.trim(),
      lastName: lastName.value.trim(),
      email: email.value.trim(),
      jobTitle: jobTitle.value.trim(),
      systemRole: role,
      location: locationSel.value,
      permissionIds
    };

    // update demo dataset
    if(editingId){
      const idx = staff.findIndex(x=>x.id===editingId);
      staff[idx] = { ...staff[idx], ...payload };
      // keep status
      staff[idx].status = staff[idx].status || "Active";
    } else {
      staff.unshift({
        id: "u" + Math.floor(Math.random()*9000+1000),
        status:"Active",
        ...payload
      });
    }

    renderTable();
    writeOutput(payload);

    showToast("Saved (demo). Payload shown in Developer View panel.");
    closeModal();
  });

  // init
  renderTable();
  writeOutput({
    note: "Click Edit on a user, select ADMIN, and observe the permissions panel appear automatically.",
    example_payload_shape: { userId: "u123", systemRole: "ADMIN", permissionIds: ["staff.view","payroll.view"] }
  });
</script>
</body>
</html>
